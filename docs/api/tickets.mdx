# Tickets API Documentation

## Overview

The Tickets module is the core of the iComplain Facility Issue Tracking System. It manages the creation, updating, tracking, and resolution of facility-related issues reported by students. This documentation covers the models, endpoints, business rules, and related files for ticket management.

---

## Table of Contents
- [Ticket Model](#ticket-model)
- [Endpoints](#endpoints)
- [Business Rules](#business-rules)
- [Status Workflow](#status-workflow)
- [Attachments & Media](#attachments--media)
- [Comments & Communication](#comments--communication)
- [History & Audit Trail](#history--audit-trail)
- [Permissions](#permissions)
- [Related Files](#related-files)

---

## Ticket Model

Represents a facility issue reported by a student. Includes fields for title, description, location, priority, status, attachments, and audit trail.

**Key Fields:**
- `id`: Unique identifier
- `title`: Short summary of the issue
- `description`: Detailed explanation
- `location`: Facility or area affected
- `priority`: [Low, Medium, High]
- `status`: [Pending, In Progress, Resolved, Closed, Cancelled]
- `created_by`: Student who reported
- `assigned_to`: Admin/Staff assigned
- `created_at`, `updated_at`: Timestamps

---

## Endpoints

```
POST   /api/tickets/                # Create new ticket
GET    /api/tickets/                # List all tickets (filtered by user/role)
GET    /api/tickets/{id}/           # Get specific ticket details
PUT    /api/tickets/{id}/           # Update ticket (if allowed)
DELETE /api/tickets/{id}/           # Delete ticket (if allowed)

# Attachments
POST   /api/tickets/{id}/attachments/     # Upload file
GET    /api/tickets/{id}/attachments/     # List attachments
DELETE /api/tickets/{id}/attachments/{attachment_id}/  # Remove file

# Comments
POST   /api/tickets/{id}/comments/            # Add comment
GET    /api/tickets/{id}/comments/            # List comments
PUT    /api/tickets/{id}/comments/{comment_id}/  # Edit own comment
DELETE /api/tickets/{id}/comments/{comment_id}/  # Delete own comment

# Status & History
GET    /api/tickets/{id}/status/         # Get status history
GET    /api/tickets/{id}/timeline/       # Get full timeline
GET    /api/tickets/{id}/history/        # Full audit trail

# Feedback
POST   /api/tickets/{id}/feedback/      # Submit feedback
GET    /api/tickets/{id}/feedback/      # View feedback
PUT    /api/tickets/{id}/feedback/      # Update feedback
```

---

## Business Rules
- Students can only edit or delete tickets in "Pending" status.
- Location, title, and description are required.
- Initial priority defaults to "Medium"; admins can change it.
- Max 5 attachments per ticket; max 5MB per file.
- Only allowed formats: JPEG, PNG, WebP, PDF.
- Comments can be edited within 5 minutes; cannot delete if admin replied.
- Status transitions: Pending → In Progress → Resolved → Closed/Cancelled.
- Feedback can be submitted only after ticket is marked "Resolved".

---

## Status Workflow

```
Pending → In Progress → Resolved → Closed
   ↓           ↓            ↓
   └─────── Cancelled ──────┘
```

| Status        | Description                          | Actions Allowed         |
|---------------|--------------------------------------|------------------------|
| Pending       | Awaiting admin review                | Edit/Delete            |
| In Progress   | Admin working on issue               | Comment                |
| Resolved      | Awaiting student confirmation        | Feedback               |
| Closed        | Ticket completed and verified        | View only              |
| Cancelled     | Withdrawn or marked as duplicate     | View only              |

---

## Attachments & Media
- Attachments are stored in `media/tickets/` (dev) or S3/Spaces (prod).
- File validation: type, size, and count enforced.
- Images auto-compressed to max 1920px width.
- Secure access via signed URLs in production.

---

## Comments & Communication
- Threaded comments between students and admins.
- Admin comments trigger email notifications.
- Comments are read-only after ticket is closed.

---

## History & Audit Trail
- All changes (status, priority, comments, files) are logged.
- Full audit trail available via `/api/tickets/{id}/history/`.

---

## Permissions
- Students: Can CRUD own tickets (with restrictions), comment, upload files, give feedback.
- Admins: Can view all tickets, assign, change status, comment, and manage attachments.

---

## Related Files

```
backend/apps/tickets/
├── models.py        # Ticket, Attachment, Comment, StatusHistory, Feedback models
├── serializers.py   # Serializers for API
├── views.py         # Viewsets and endpoints
├── permissions.py   # Custom permissions
├── filters.py       # Filtering logic
├── utils.py         # File processing utilities
├── storage.py       # Custom storage backend
├── signals.py       # Notification triggers, audit logging
└── tests/
    ├── test_models.py
    ├── test_views.py
    └── test_permissions.py
```

---

**Last Updated:** February 2026
**Maintained by:** The Square Thing
